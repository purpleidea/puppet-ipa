#!/bin/bash

# README:
# This script loops through listed items and removes those which are not known.
# This is so that when puppet removes the 'tag' file the actual item gets rm'd.
# An optional list of bash matches can be provided to spare removal if matched.
#
# NOTE:
# The following variables were used to build this script:
#	id_dir:	<%= id_dir %>
#	ls_cmd:	<%= ls_cmd %>
#	rm_cmd:	<%= rm_cmd %>
#	fs_chr: <%= fs_chr %>
#	suffix: <%= suffix %>
#	regexp: <%= regexp.join(' ') %>
#

for i in `<%= ls_cmd %> | /bin/awk -F '<%= fs_chr %>' '{print $1}'`; do
	#echo "$i"

	# this section is essentially an in_array()
	found=false
	for j in <%= scope.lookupvar('::ipa::vardir::module_vardir').gsub(/\/$/, '') %>/<%= id_dir %>/*; do
		#echo "found tag: $j"
		if [ "$i" == "`basename $j <%= suffix %>`" ]; then
			found=true	# found it -- it's safe
			break
		fi
	done

<% if regexp != [] -%>
	matched=false

	# quoting the match pattern indicate a string match (bash v3.2+)
<% regexp.each do |m| -%>
	if [[ "$i" =~ <%= m %> ]]; then
		matched=true
	fi
<% end -%>

	# if not found, and not matched, then it should be removed
	if ! $found && ! $matched; then
<% else -%>
	# if not found, then it should be removed
	if ! $found; then
<% end -%>
		# echo "Removing: $i"
		<%= rm_cmd %>"$i"
	fi
done

